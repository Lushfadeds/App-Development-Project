{% extends "base.html" %}
{% block content %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Points System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='points_system.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>
<body>
    <div class="container my-4">
        <header class="text-center mb-4">
            <h1>Points System</h1>
            <p>Total Points: <span id="totalPoints">0</span></p>
        </header>

        <!-- Weekly Progress Bar -->
        <div class="text-center mb-4">
            <div class="btn-group">
                {% for name in ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] %}
                    <button class="btn btn-outline-primary daily-btn" data-day="{{ loop.index0 }}">{{ name }}</button>
                {% endfor %}
            </div>
            <p id="dailyMessage" class="text-success mt-2"></p>
        </div>

        <!-- Spin Wheel Section -->
        <div class="text-center">
            <canvas id="wheelCanvas" width="300" height="300"></canvas>
            <button id="spinButton" class="btn btn-primary mt-3">Spin</button>
            <p id="spinMessage" class="text-success mt-3"></p>
        </div>
    </div>

    <script>

        // Update total points dynamically
        function updateTotalPoints(points) {
            $('#totalPoints').text(points);
        }

        // Daily Check-in Button Logic
        $('.daily-btn').click(function() {
            const day = $(this).data('day');
            $.post('/collect-points', JSON.stringify({ day: day }), (response) => {
                $('#dailyMessage').text(response.message);
                if (response.success) updateTotalPoints(response.total_points);
            }, 'json');
        });

        // Spin Wheel Logic
        const canvas = document.getElementById("wheelCanvas");
        const ctx = canvas.getContext("2d");
        const segments = ["0 Points", "2 Points", "3 Points", "5 Points", "0 Points", "Try Again", "2 Points", "House Loses"];
        const segmentAngle = 2 * Math.PI / segments.length;

        let rotation = 0;
        let spinning = false;

        function drawWheel() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas before drawing again

            for (let i = 0; i < segments.length; i++) {
                ctx.beginPath();
                ctx.moveTo(150, 150);
                ctx.arc(150, 150, 150, rotation + i * segmentAngle, rotation + (i + 1) * segmentAngle);
                ctx.fillStyle = i % 2 === 0 ? "#f8f9fa" : "#6c757d";
                ctx.fill();
                ctx.stroke();
                ctx.save();
                ctx.translate(150, 150);
                ctx.rotate(i * segmentAngle + segmentAngle / 2);
                ctx.textAlign = "center";
                ctx.fillStyle = "#000";
                ctx.fillText(segments[i], 100, 5);
                ctx.restore();
            }
        }

        function spinWheel() {
            if (spinning) return;

            spinning = true;
            let spinDuration = 3000; // Spin duration in milliseconds
            let spinSpeed = 0.05; // Speed of rotation
            let startTime = Date.now();

            function animateSpin() {
                const elapsedTime = Date.now() - startTime;
                if (elapsedTime < spinDuration) {
                    rotation += spinSpeed;
                    drawWheel();
                    requestAnimationFrame(animateSpin);
                } else {
                    // Finalize the wheel after the spin duration
                    const resultIndex = Math.floor(((rotation % (2 * Math.PI)) / segmentAngle));
                    $('#spinMessage').text("Result: " + segments[resultIndex]);
                    spinning = false;
                }
            }

            animateSpin();
        }

        $('#spinButton').click(function() {
            spinWheel(); // Trigger the spin animation
        });
    </script>
</body>
</html>
{% endblock %}
